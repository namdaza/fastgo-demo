<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FastGo ‚Äì App Xe √îm C√¥ng Ngh·ªá (Frontend)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --fastgo-orange:#ff7a00;
      --fg-bg:#fff7f0;
      --fg-dark:#262626;
      --fg-muted:#6b7280;
      --accent:#16a34a;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--fg-bg);color:var(--fg-dark)}
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 16px;background:var(--fastgo-orange);color:white;position:sticky;top:0;z-index:800
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:800;letter-spacing:.3px}
    .brand .logo{width:32px;height:32px;border-radius:8px;background:white;color:var(--fastgo-orange);display:grid;place-items:center;font-weight:900}
    .container{display:grid;grid-template-columns:360px 1fr;gap:10px;padding:10px}
    @media (max-width: 980px){.container{grid-template-columns:1fr}.side{order:2}.mapwrap{order:1;height:60vh}}
    .card{background:white;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:12px}
    .section-title{font-size:14px;font-weight:800;color:#374151;text-transform:uppercase;letter-spacing:.08em;margin:4px 0 8px}
    .muted{color:var(--fg-muted)}
    .row{display:flex;gap:8px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .row.space{justify-content:space-between}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--fastgo-orange);color:white}
    .btn.ghost{background:#fff;border:1px solid #e5e7eb}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.success{background:var(--accent);color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input,select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;outline:none}
    input[type="range"]{padding:0}
    label{font-size:12px;color:#374151;font-weight:700}
    small{color:var(--fg-muted)}
    .mapwrap{min-height:72vh}
    #map{width:100%;height:100%;min-height:340px;border-radius:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .stack{display:grid;gap:8px}
    .divider{height:1px;background:#f3f4f6;margin:8px 0}
    .pill{padding:6px 10px;background:#fff7ed;border:1px dashed #fdba74;border-radius:999px;color:#9a3412;font-size:12px}
    .status{font-weight:800}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:900}
    .modal.open{display:grid}
    .modal .box{width:min(520px,94vw);background:white;border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.2)}
    .stars{display:flex;gap:6px;font-size:24px;cursor:pointer}
    .star{filter:grayscale(1);opacity:.4}
    .star.active{filter:none;opacity:1}

    .tagpay{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .tagpay.selected{outline:2px solid var(--fastgo-orange)}

    .mini{font-size:12px}
    .eta{font-weight:800}

    /* Driver marker (orange) with status */
    .driver-marker{position:relative;width:36px;height:36px;transform:translateY(-6px)}
    .driver-marker .dot{width:24px;height:24px;border-radius:9999px;background:var(--fastgo-orange);border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.25);position:absolute;left:50%;top:50%;transform:translate(-50%,-50%)}
    .driver-marker .badge{position:absolute;left:50%;top:100%;transform:translate(-50%,4px);font-size:10px;font-weight:800;padding:2px 6px;border-radius:999px;background:#111827;color:#fff;white-space:nowrap}
    .driver-marker.accept .badge{background:#2563eb}
    .driver-marker.drive .badge{background:#f59e0b}
    .driver-marker.done .badge{background:#16a34a}
    .driver-marker.drive .pulse{position:absolute;left:50%;top:50%;width:24px;height:24px;border:3px solid rgba(255,122,0,.5);border-radius:9999px;transform:translate(-50%,-50%);animation:pulse 1.4s ease-out infinite}
    @keyframes pulse{0%{transform:translate(-50%,-50%) scale(1);opacity:.7}70%{transform:translate(-50%,-50%) scale(1.8);opacity:0}100%{opacity:0}}

    /* Suggestion dropdown */
    .suggest{display:none;background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin-top:6px;max-height:180px;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .suggest .item{padding:8px 10px;cursor:pointer;font-size:13px;line-height:1.3}
    .suggest .item:hover{background:#f3f4f6}
    .suggest .sub{color:var(--fg-muted);font-size:12px;display:block}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">FG</div>
      <div>
        <div>FastGo</div>
        <small class="muted">Xe √¥m c√¥ng ngh·ªá (Demo Frontend)</small>
      </div>
    </div>
    <div class="row" id="userArea">
      <div class="muted mini" id="hello">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
      <button type="button" class="btn ghost" id="btnLogin">ƒêƒÉng nh·∫≠p</button>
      <button type="button" class="btn ghost" id="btnLogout" style="display:none">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <div class="container">
    <!-- Side Panel -->
    <aside class="side stack">
      <section class="card">
        <div class="section-title">1) ƒêi·ªÉm ƒë√≥n / ƒêi·ªÉm ƒë·∫øn</div>
        <div class="stack">
          <div class="grid">
            <div class="stack">
              <label>ƒêi·ªÉm ƒë√≥n (Pickup) <small class="muted">‚Äî nh·∫•p map ho·∫∑c t√¨m</small></label>
              <input id="pickupSearch" placeholder="VD: 2 H·∫£i Tri·ªÅu, Qu·∫≠n 1" />
              <button type="button" class="btn ghost" id="btnPickupSearch">T√¨m ƒëi·ªÉm ƒë√≥n</button>
              <div id="pickupSuggest" class="suggest"></div>
            </div>
            <div class="stack">
              <label>ƒêi·ªÉm ƒë·∫øn (Dropoff) <small class="muted">‚Äî nh·∫•p map ho·∫∑c t√¨m</small></label>
              <input id="dropoffSearch" placeholder="VD: B·∫øn xe Mi·ªÅn ƒê√¥ng" />
              <button type="button" class="btn ghost" id="btnDropoffSearch">T√¨m ƒëi·ªÉm ƒë·∫øn</button>
              <div id="dropoffSuggest" class="suggest"></div>
            </div>
          </div>

          <div class="row wrap">
            <span class="muted mini" style="min-width:140px">ƒê·∫∑t b·∫±ng click map:</span>
            <label class="row" style="gap:6px"><input type="radio" name="setMode" value="pickup" checked /> <b style="color:#b91c1c">Pickup</b></label>
            <label class="row" style="gap:6px"><input type="radio" name="setMode" value="dropoff" /> <b style="color:#065f46">Dropoff</b></label>
            <button type="button" class="btn" id="btnSwap" title="ƒê·ªïi ch·ªó ƒë√≥n/ƒë·∫øn">‚ÜïÔ∏è ƒê·ªïi ch·ªó</button>
            <button type="button" class="btn" id="btnLocate" title="L·∫•y v·ªã tr√≠ c·ªßa t√¥i">üìç V·ªã tr√≠ c·ªßa t√¥i</button>
          </div>

          <div class="divider"></div>
          <div class="row space"><span class="muted mini">Kho·∫£ng c√°ch</span><span id="txtDistance" class="eta">‚Äî</span></div>
          <div class="row space"><span class="muted mini">ETA</span><span id="txtEta" class="eta">‚Äî</span></div>
        </div>
      </section>

      <section class="card">
        <div class="section-title">2) C·∫•u h√¨nh chuy·∫øn & Gi√° ∆∞·ªõc t√≠nh</div>
        <div class="grid">
          <div class="stack">
            <label>Lo·∫°i xe</label>
            <select id="vehicle">
              <option value="bike">Bike</option>
              <option value="car">Car</option>
              <option value="suv">SUV</option>
            </select>
          </div>
          <div class="stack">
            <label>Th·ªùi ti·∫øt</label>
            <select id="weather">
              <option value="clear">Clear</option>
              <option value="rain">Rain</option>
              <option value="storm">Storm</option>
            </select>
          </div>
        </div>
        <div class="stack" style="margin-top:6px">
          <label>Giao th√¥ng: <b><span id="trafficVal">20</span>%</b></label>
          <input type="range" id="traffic" min="0" max="100" value="20" />
        </div>
        <div class="divider"></div>
        <div class="stack">
          <div class="row space"><span class="muted mini">H·ªá s·ªë Surge √ó</span><span id="txtSurge" class="eta">1.00√ó</span></div>
          <div class="row space"><span class="muted mini">Base + km √ó h·ªá s·ªë</span><span id="txtBreakdown" class="eta">‚Äî</span></div>
          <div class="row space"><span class="muted mini">Gi√° ∆∞·ªõc t√≠nh</span><span id="txtEstimate" class="eta">‚Äî</span></div>
        </div>
      </section>

      <section class="card">
        <div class="section-title">3) Thanh to√°n & Khuy·∫øn m√£i</div>
        <div class="stack">
          <div class="row wrap" id="payGroup">
            <div class="tagpay selected" data-pay="cash">üíµ Ti·ªÅn m·∫∑t</div>
            <div class="tagpay" data-pay="card">üí≥ Th·∫ª</div>
            <div class="tagpay" data-pay="momo">üì± MoMo</div>
          </div>
          <small class="muted">Voucher (ch·ªçn 1 l·∫ßn cho chuy·∫øn n√†y)</small>
          <div class="row">
            <select id="voucher">
              <option value="">‚Äî Ch·ªçn voucher ‚Äî</option>
              <option value="FAST10">FAST10 (‚àí10%)</option>
              <option value="MOMO15">MOMO15 (‚àí15%, ch·ªâ MoMo)</option>
              <option value="RAIN20">RAIN20 (‚àí20%, khi m∆∞a/b√£o)</option>
              <option value="NEW50K">NEW50K (‚àí50.000ƒë)</option>
            </select>
            <button type="button" class="btn" id="btnApplyVoucher">√Åp d·ª•ng</button>
          </div>
          <div class="divider"></div>
          <div class="row space"><span class="muted mini">Gi·∫£m gi√° (voucher)</span><span id="txtDiscount" class="eta">‚Äî</span></div>
          <div class="row space"><span class="muted mini">T·ªïng thanh to√°n</span><span id="txtTotal" class="eta">‚Äî</span></div>
        </div>
      </section>

      <section class="card">
        <div class="section-title">4) ƒê·∫∑t t√†i x·∫ø & Theo d√µi</div>
        <div class="stack">
          <div id="driverCard" class="pill">Ch∆∞a c√≥ t√†i x·∫ø</div>
          <div class="row wrap">
            <button type="button" class="btn primary" id="btnBook">ƒê·∫∑t t√†i x·∫ø</button>
            <button type="button" class="btn danger" id="btnCancel" disabled>Hu·ª∑ chuy·∫øn</button>
            <button type="button" class="btn success" id="btnFinish" disabled>K·∫øt th√∫c</button>
          </div>
          <div class="row space"><span class="muted mini">Tr·∫°ng th√°i</span><span class="status" id="txtStatus">Ch∆∞a ƒë·∫∑t</span></div>
        </div>
      </section>
    </aside>

    <!-- Map -->
    <main class="mapwrap card">
      <div id="map"></div>
    </main>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="box">
      <h3>ƒêƒÉng nh·∫≠p kh√°ch h√†ng</h3>
      <p class="muted mini">Nh·∫≠p t√™n v√† s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ hi·ªÉn th·ªã tr√™n header (l∆∞u localStorage).</p>
      <div class="grid">
        <div class="stack"><label>T√™n</label><input id="loginName" placeholder="Nguy·ªÖn VƒÉn A"/></div>
        <div class="stack"><label>S·ªë ƒëi·ªán tho·∫°i</label><input id="loginPhone" placeholder="09xxxxxxxx"/></div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button type="button" class="btn ghost" id="btnCloseLogin">ƒê√≥ng</button>
        <button type="button" class="btn primary" id="btnDoLogin">ƒêƒÉng nh·∫≠p</button>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="modal" id="ratingModal" aria-hidden="true">
    <div class="box">
      <h3>ƒê√°nh gi√° chuy·∫øn ƒëi</h3>
      <div class="stars" id="stars">
        <span class="star" data-val="1">‚òÖ</span>
        <span class="star" data-val="2">‚òÖ</span>
        <span class="star" data-val="3">‚òÖ</span>
        <span class="star" data-val="4">‚òÖ</span>
        <span class="star active" data-val="5">‚òÖ</span>
      </div>
      <div class="stack" style="margin-top:8px">
        <label>L·ªùi nh·∫Øn</label>
        <input id="ratingNote" placeholder="R·∫•t h√†i l√≤ng!"/>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button type="button" class="btn ghost" id="btnCloseRating">ƒê√≥ng</button>
        <button type="button" class="btn primary" id="btnSubmitRating">G·ª≠i ƒë√°nh gi√°</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // ===== Fallback UI n·∫øu map l·ªói =====
  function showMapLoadError(err){
    const el=document.getElementById('map'); if(!el) return;
    el.innerHTML =
      '<div style="display:grid;place-items:center;height:100%;padding:16px;text-align:center">' +
      '<div><b>Kh√¥ng t·∫£i ƒë∆∞·ª£c b·∫£n ƒë·ªì</b><br/><small>Ki·ªÉm tra m·∫°ng ho·∫∑c m·ªü b·∫±ng Live Server.' +
      (err && err.message ? (' L·ªói: '+err.message) : '') +
      '</small></div></div>';
  }

  // ====== State ======
  const state = {
    user: null,
    map: null,
    followDriver: true,
    speedMultiplier: 2, // ch·∫°y nhanh g·∫•p ƒë√¥i
    pickup: null,
    dropoff: null,
    pickupMarker: null,
    dropoffMarker: null,
    driverMarker: null,
    routeLine: null,
    routeCoords: [],
    distanceKm: 0,
    durationMin: 0,
    setMode: 'pickup',
    booking: { status: 'Ch∆∞a ƒë·∫∑t', driver: null, animTimer: null },
    pricing: {
      vehicle:'bike', traffic: 20, weather:'clear', surge:1.0,
      breakdown:'', estimate:0, payment:'cash', voucher:null,
      discount:0, total:0, voucherLocked:false
    }
  };

  // ====== Utils ======
  const fmtVnd = v => (Math.round(v/1000)*1000).toLocaleString('vi-VN') + ' ƒë';
  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
  const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));

  // Icons
  const svgPin = (color='#ef4444')=> {
    const svg = encodeURIComponent(
      "<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='36' height='48' viewBox='0 0 36 48' fill='none'><path d='M18 0C8.06 0 0 8.06 0 18c0 12.08 15.06 29.48 16.7 31.34.73.84 1.87.84 2.6 0C20.94 47.48 36 30.08 36 18 36 8.06 27.94 0 18 0Z' fill='"+color+"'/><circle cx='18' cy='18' r='6.5' fill='white'/></svg>"
    );
    return L.icon({ iconUrl:'data:image/svg+xml,'+svg, iconSize:[28,36], iconAnchor:[14,34], popupAnchor:[0,-28] });
  }
  function driverDivIcon(status='accept'){
    const label = status==='accept'? 'Nh·∫≠n' : (status==='drive'? 'Ch·ªü' : 'Xong');
    const html =
      '<div class="driver-marker '+status+'">'+
        '<div class="dot"></div>'+
        (status==='drive'?'<div class="pulse"></div>':'')+
        '<div class="badge">'+label+'</div>'+
      '</div>';
    return L.divIcon({ html, className:'', iconSize:[36,36], iconAnchor:[18,28], popupAnchor:[0,-28] });
  }
  function updateDriverIcon(status){ if(state.driverMarker) state.driverMarker.setIcon(driverDivIcon(status)); }

  // ====== Init Map ======
  function initMap(){
    if(typeof L==='undefined'){ throw new Error('Leaflet not loaded'); }
    state.map = L.map('map').setView([10.776, 106.700], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(state.map);

    state.map.on('click', (e)=>{
      const {latlng} = e;
      if(state.setMode==='pickup') setPickup(latlng.lat, latlng.lng, true);
      else setDropoff(latlng.lat, latlng.lng, true);
    });
  }

  // ====== Markers & Routing ======
  function setPickup(lat,lng, fit=false){
    if(!state.map){ alert('B·∫£n ƒë·ªì ch∆∞a s·∫µn s√†ng.'); return; }
    state.pickup = {lat,lng};
    if(!state.pickupMarker){
      state.pickupMarker = L.marker([lat,lng], {draggable:true, icon: svgPin('#dc2626'), title:'Pickup'}).addTo(state.map);
      state.pickupMarker.on('dragend', ev=>{
        const p = ev.target.getLatLng();
        state.pickup = {lat:p.lat, lng:p.lng};
        tryRoute();
      });
    }else state.pickupMarker.setLatLng([lat,lng]);
    if(fit) state.map.setView([lat,lng], 15);
    const bx=document.getElementById('pickupSuggest'); if(bx) bx.style.display='none';
    tryRoute();
  }
  function setDropoff(lat,lng, fit=false){
    if(!state.map){ alert('B·∫£n ƒë·ªì ch∆∞a s·∫µn s√†ng.'); return; }
    state.dropoff = {lat,lng};
    if(!state.dropoffMarker){
      state.dropoffMarker = L.marker([lat,lng], {draggable:true, icon: svgPin('#059669'), title:'Dropoff'}).addTo(state.map);
      state.dropoffMarker.on('dragend', ev=>{
        const p = ev.target.getLatLng();
        state.dropoff = {lat:p.lat, lng:p.lng};
        tryRoute();
      });
    }else state.dropoffMarker.setLatLng([lat,lng]);
    if(fit) state.map.setView([lat,lng], 15);
    const bx2=document.getElementById('dropoffSuggest'); if(bx2) bx2.style.display='none';
    tryRoute();
  }
  function clearRoute(){
    state.routeCoords = [];
    state.distanceKm = 0; state.durationMin = 0;
    if(state.routeLine){state.map.removeLayer(state.routeLine); state.routeLine=null}
    document.getElementById('txtDistance').textContent='‚Äî';
    document.getElementById('txtEta').textContent='‚Äî';
    recalcPrice();
  }
  async function tryRoute(){
    if(!(state.pickup && state.dropoff)) { clearRoute(); return; }
    const url = `https://router.project-osrm.org/route/v1/driving/${state.pickup.lng},${state.pickup.lat};${state.dropoff.lng},${state.dropoff.lat}?overview=full&geometries=geojson`;
    try{
      const res = await fetch(url);
      const data = await res.json();
      if(!data.routes || !data.routes.length) throw new Error('No route');
      const route = data.routes[0];
      const coords = route.geometry.coordinates.map(([lng,lat])=>[lat,lng]);
      state.routeCoords = coords;
      state.distanceKm = route.distance/1000;
      state.durationMin = route.duration/60;

      if(state.routeLine) state.map.removeLayer(state.routeLine);
      state.routeLine = L.polyline(coords, {color:'#111827', weight:5, opacity:.75}).addTo(state.map);
      state.map.fitBounds(state.routeLine.getBounds(), {padding:[30,30]});

      document.getElementById('txtDistance').textContent = state.distanceKm.toFixed(2) + ' km';
      document.getElementById('txtEta').textContent = Math.round(state.durationMin) + ' ph√∫t';
      recalcPrice();
    }catch(e){
      console.error(e);
      clearRoute();
      alert('Kh√¥ng t√≠nh ƒë∆∞·ª£c tuy·∫øn ƒë∆∞·ªùng (OSRM). H√£y th·ª≠ v·ªã tr√≠ kh√°c.');
    }
  }

  // ====== Geocoding (Nominatim) + Suggest ======
  async function geocode(query){
    const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(query)}&limit=5&addressdetails=1&accept-language=vi`;
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    return await res.json();
  }
  function renderSuggest(which, results){
    const box = document.getElementById(which+'Suggest');
    if(!box) return;
    if(!results || !results.length){ box.style.display='none'; box.innerHTML=''; return; }
    box.innerHTML = results.map(r=>{
      const main = (r.address && (r.address.road||r.address.neighbourhood||r.address.suburb||r.address.village||r.address.town||r.address.city)) || (r.display_name||'').split(',')[0];
      const lat = r.lat, lon = r.lon;
      return `<div class="item" data-lat="${lat}" data-lon="${lon}"><b>${main||'V·ªã tr√≠'}</b><span class="sub">${r.display_name||''}</span></div>`;
    }).join('');
    box.style.display='block';
    box.querySelectorAll('.item').forEach(it=>{
      it.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const lat=parseFloat(it.dataset.lat), lon=parseFloat(it.dataset.lon);
        if(which==='pickup') setPickup(lat, lon, true); else setDropoff(lat, lon, true);
        box.style.display='none';
      });
    });
  }
  async function searchSuggest(which, query){
    try{
      const results = await geocode(query);
      renderSuggest(which, results);
    }catch(e){
      alert('Kh√¥ng t√¨m ƒë∆∞·ª£c k·∫øt qu·∫£ (Nominatim).');
    }
  }
  // (Optional) fallback: l·∫•y k·∫øt qu·∫£ ƒë·∫ßu ti√™n
  async function searchAndSet(which, query){
    const results = await geocode(query);
    if(!results.length){ alert('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ.'); return; }
    const r = results[0];
    if(which==='pickup') setPickup(parseFloat(r.lat), parseFloat(r.lon), true);
    else setDropoff(parseFloat(r.lat), parseFloat(r.lon), true);
  }

  // --- Road animation helpers ---
  async function osrmRoute(from, to){
    const url = `https://router.project-osrm.org/route/v1/driving/${from[1]},${from[0]};${to[1]},${to[0]}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.routes || !data.routes.length) throw new Error('OSRM route not found');
    const r = data.routes[0];
    return { coords: r.geometry.coordinates.map(([lng,lat])=>[lat,lng]), distance: r.distance, duration: r.duration };
  }
  function interpolate(a,b,t){ return [ a[0]+(b[0]-a[0])*t, a[1]+(b[1]-a[1])*t ]; }
  function distanceLL(a,b){
    const R=6371000; const toRad=x=>x*Math.PI/180;
    const dLat=toRad(b[0]-a[0]); const dLon=toRad(b[1]-a[1]);
    const lat1=toRad(a[0]); const lat2=toRad(b[0]);
    const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(x));
  }
  function buildSegs(coords){
    const segs=[]; const cum=[0]; let total=0;
    for(let i=1;i<coords.length;i++){ const d=distanceLL(coords[i-1], coords[i]); segs.push(d); total+=d; cum.push(total); }
    return {segs, cum, total};
  }
  function animateAlongRoad(coords, mps, onDone, statusTag='drive'){
    if(!coords || coords.length<2) { onDone&&onDone(); return; }
    if(!state.driverMarker) state.driverMarker = L.marker(coords[0], {icon: driverDivIcon(statusTag)}).addTo(state.map);
    else state.driverMarker.setLatLng(coords[0]);
    updateDriverIcon(statusTag);

    const {segs, cum, total} = buildSegs(coords);
    const t0 = performance.now();
    function step(now){
      const elapsed=(now-t0)/1000; const dist=Math.min(elapsed*mps, total);
      let i=0; while(i<segs.length-1 && cum[i+1] <= dist) i++;
      const segLen=segs[i]||1; const segStart=cum[i];
      const localT=clamp((dist-segStart)/segLen,0,1);
      const p=interpolate(coords[i], coords[i+1]||coords[i], localT);
      state.driverMarker.setLatLng(p);
      if(state.followDriver) state.map.panTo(p,{animate:false});
      if(dist<total) state.booking.animTimer=requestAnimationFrame(step); else onDone&&onDone();
    }
    state.booking.animTimer=requestAnimationFrame(step);
  }

  // ====== Pricing ======
  function recalcPrice(){
    const dkm = state.distanceKm;
    const vehicle = state.pricing.vehicle;
    const traffic = state.pricing.traffic;
    const weather = state.pricing.weather;
    const v = { bike:{base:5000, perkm:7000, factor:1.0}, car:{base:10000, perkm:11000, factor:1.3}, suv:{base:15000, perkm:15000, factor:1.6} }[vehicle];

    // fuzzy traffic
    const t = traffic; const muL = clamp((30 - t)/30, 0, 1); const muM = clamp(1 - Math.abs(t - 50)/20, 0, 1); const muH = clamp((t - 70)/30, 0, 1);
    const wClear = weather==='clear' ? 1 : 0; const wRain  = weather==='rain' ? 1 : 0; const wStorm = weather==='storm'? 1 : 0;
    const sLow=1.0*wClear+1.1*(wRain||wStorm), sMed=1.2*wClear+1.3*wRain+1.4*wStorm, sHigh=1.5*wClear+1.7*wRain+1.9*wStorm;
    let surge = (muL*(sLow||1.0)+muM*(sMed||1.2)+muH*(sHigh||1.5))/(muL+muM+muH||1); surge = clamp(surge,1.0,2.5);

    const subtotal = (v.base + dkm*v.perkm) * v.factor * surge;

    // voucher
    const voucher = state.pricing.voucher;
    const pay = state.pricing.payment;
    let discount = 0;
    if(voucher){
      if(voucher==='FAST10') discount = 0.10 * subtotal;
      if(voucher==='MOMO15' && pay==='momo') discount = 0.15 * subtotal;
      if(voucher==='RAIN20' && (weather==='rain'||weather==='storm')) discount = 0.20 * subtotal;
      if(voucher==='NEW50K') discount = 50000;
    }
    const total = Math.max(0, subtotal - discount);

    state.pricing.surge=surge; state.pricing.estimate=subtotal; state.pricing.discount=discount; state.pricing.total=total;
    document.getElementById('txtSurge').textContent = surge.toFixed(2)+'√ó';
    document.getElementById('txtBreakdown').textContent = fmtVnd(v.base)+' + '+fmtVnd(v.perkm)+' /km √ó '+v.factor.toFixed(2);
    document.getElementById('txtEstimate').textContent = dkm>0? fmtVnd(subtotal) : '‚Äî';
    document.getElementById('txtDiscount').textContent = discount>0? '‚àí '+fmtVnd(discount) : '‚Äî';
    document.getElementById('txtTotal').textContent = dkm>0? fmtVnd(total) : '‚Äî';
  }

  // ===== Voucher g·ª£i √Ω t·ª± ƒë·ªông (kh√¥ng auto-apply) =====
  function recommendVoucherCode(){
    const pay=state.pricing.payment; const weather=state.pricing.weather;
    if(weather==='rain'||weather==='storm') return 'RAIN20';
    if(pay==='momo') return 'MOMO15';
    return '';
  }
  function maybeSuggestVoucher(){
    if(state.pricing.voucherLocked) return;
    const rec=recommendVoucherCode();
    const sel=document.getElementById('voucher');
    const btn=document.getElementById('btnApplyVoucher');
    if(!sel) return;
    sel.value = rec || '';
    if(btn) btn.disabled=false;
  }
  function resetVoucherUI(){
    const sel=document.getElementById('voucher');
    const btn=document.getElementById('btnApplyVoucher');
    state.pricing.voucher=null;
    state.pricing.voucherLocked=false;
    if(sel){ sel.disabled=false; sel.value=''; }
    if(btn){ btn.disabled=false; }
    maybeSuggestVoucher();
    recalcPrice();
  }

  // ====== Booking & flow ======
  function setStatus(s){ state.booking.status=s; document.getElementById('txtStatus').textContent=s; }
  function randomDriver(){
    const pool=[
      {name:'Nguy·ªÖn VƒÉn T√®o', plate:'59A1-123.45', vehicle:'Wave Alpha', rating:4.92, phone:'0909 123 456'},
      {name:'Tr·∫ßn Th·ªã B∆∞·ªüi', plate:'51F-888.68', vehicle:'Vision', rating:4.85, phone:'0707 555 666'},
      {name:'L√™ Ho√†ng', plate:'60B-222.33', vehicle:'Exciter', rating:4.97, phone:'0933 777 888'}
    ];
    return pool[Math.floor(Math.random()*pool.length)];
  }
  function showDriverCard(){
    const d=state.booking.driver; const el=document.getElementById('driverCard');
    if(!d){ el.textContent='Ch∆∞a c√≥ t√†i x·∫ø'; return; }
    el.innerHTML = 'üöñ <b>'+d.name+'</b> ‚Ä¢ '+d.vehicle+' ‚Ä¢ '+d.plate+' ‚Ä¢ ‚≠ê '+d.rating+' ‚Ä¢ üìû '+d.phone;
  }
  function resetDriver(){
    if(state.driverMarker){state.map.removeLayer(state.driverMarker); state.driverMarker=null}
    if(state.booking.animTimer){cancelAnimationFrame(state.booking.animTimer); state.booking.animTimer=null}
    state.booking.driver=null; showDriverCard();
    document.getElementById('btnCancel').disabled=true;
    document.getElementById('btnFinish').disabled=true;
    resetVoucherUI();
  }

  async function bookDriver(){
    if(!state.routeCoords.length){ alert('Vui l√≤ng ch·ªçn ƒëi·ªÉm ƒë√≥n/ƒëi·ªÉm ƒë·∫øn ƒë·ªÉ t√≠nh tuy·∫øn.'); return; }
    setStatus('ƒêang t√¨m'); const btn=document.getElementById('btnBook'); btn.disabled=true;
    document.getElementById('btnCancel').disabled=false;

    await sleep(600);
    state.booking.driver = randomDriver();
    showDriverCard();
    setStatus('ƒê√£ nh·∫≠n cu·ªëc');

    // Approach to pickup via road route
    const pk = state.routeCoords[0];
    const offset = 0.0015; // ~150m
    const driverStart = [pk[0] + (Math.random()-.5)*offset, pk[1] + (Math.random()-.5)*offset];
    if(!state.driverMarker) state.driverMarker = L.marker(driverStart, {icon: driverDivIcon('accept')}).addTo(state.map);
    else { state.driverMarker.setLatLng(driverStart); updateDriverIcon('accept'); }

    let approach;
    try{
      approach = await osrmRoute(driverStart, pk);
    }catch(e){
      const d=distanceLL(driverStart, pk);
      approach={coords:[driverStart, pk], distance:d, duration:Math.max(8, d/8)};
    }
    const approachMps = Math.max(4, approach.distance/Math.max(approach.duration,1)) * state.speedMultiplier;
    await new Promise(res=> animateAlongRoad(approach.coords, approachMps, res, 'accept'));

    setStatus('ƒêang ch·ªü'); updateDriverIcon('drive');

    const rideMps = (state.distanceKm*1000)/Math.max(state.durationMin*60,1) * state.speedMultiplier;
    await new Promise(res=> animateAlongRoad(state.routeCoords, rideMps, res, 'drive'));

    setStatus('ƒê√£ ho√†n t·∫•t'); updateDriverIcon('done');
    document.getElementById('btnFinish').disabled=false;
    openModal('ratingModal');
  }

  function cancelTrip(){
    setStatus('ƒê√£ hu·ª∑');
    resetDriver();
    document.getElementById('btnBook').disabled=false;
  }

  // ====== Rating & Storage ======
  function openModal(id){ document.getElementById(id).classList.add('open'); }
  function closeModal(id){ document.getElementById(id).classList.remove('open'); }
  function loadUser(){
    try{ state.user=JSON.parse(localStorage.getItem('fastgo_user')); }catch(e){}
    const hello=document.getElementById('hello');
    const btnLogin=document.getElementById('btnLogin');
    const btnLogout=document.getElementById('btnLogout');
    if(state.user){
      hello.textContent='Xin ch√†o, '+state.user.name+' ('+state.user.phone+')';
      btnLogin.style.display='none'; btnLogout.style.display='inline-block';
    } else {
      hello.textContent='Ch∆∞a ƒëƒÉng nh·∫≠p';
      btnLogin.style.display='inline-block'; btnLogout.style.display='none';
    }
  }
  function saveRating(stars, note){
    let arr=[]; try{ arr=JSON.parse(localStorage.getItem('fastgo_ratings'))||[] }catch(e){}
    arr.push({stars, note, at:new Date().toISOString(), driver: state.booking.driver});
    localStorage.setItem('fastgo_ratings', JSON.stringify(arr));
  }

  // ====== Wire UI ======
  function wire(){
    // Login
    document.getElementById('btnLogin').onclick = ()=>{ openModal('loginModal'); };
    document.getElementById('btnCloseLogin').onclick = ()=> closeModal('loginModal');
    document.getElementById('btnLogout').onclick = ()=>{ localStorage.removeItem('fastgo_user'); state.user=null; loadUser(); };
    document.getElementById('btnDoLogin').onclick = ()=>{
      const name=document.getElementById('loginName').value.trim();
      const phone=document.getElementById('loginPhone').value.trim();
      if(!name || !phone) { alert('Nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n & s·ªë ƒëi·ªán tho·∫°i'); return; }
      localStorage.setItem('fastgo_user', JSON.stringify({name, phone}));
      closeModal('loginModal'); loadUser();
    };

    // Set mode
    document.querySelectorAll('input[name="setMode"]').forEach(r=>{
      r.addEventListener('change', (e)=>{ state.setMode = e.target.value; });
    });

    // Search buttons -> suggest list
    document.getElementById('btnPickupSearch').onclick = ()=>{
      const q=document.getElementById('pickupSearch').value.trim(); if(q) searchSuggest('pickup', q);
    };
    document.getElementById('btnDropoffSearch').onclick = ()=>{
      const q=document.getElementById('dropoffSearch').value.trim(); if(q) searchSuggest('dropoff', q);
    };
    // Enter-to-search
    document.getElementById('pickupSearch').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ const q=e.target.value.trim(); if(q) searchSuggest('pickup', q); }
    });
    document.getElementById('dropoffSearch').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ const q=e.target.value.trim(); if(q) searchSuggest('dropoff', q); }
    });
    // Click outside -> hide suggest
    document.addEventListener('click', (e)=>{
      ['pickupSuggest','dropoffSuggest'].forEach(id=>{
        const box=document.getElementById(id);
        const input=(id==='pickupSuggest')?document.getElementById('pickupSearch'):document.getElementById('dropoffSearch');
        if(!box) return;
        if(box.contains(e.target) || input.contains(e.target)) return;
        box.style.display='none';
      });
    });

    // Locate me
    document.getElementById('btnLocate').onclick = ()=>{
      if(!navigator.geolocation){ alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude, longitude} = pos.coords;
        if(state.setMode==='pickup') setPickup(latitude, longitude, true); else setDropoff(latitude, longitude, true);
      }, ()=> alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠.'));
    };

    // Swap
    document.getElementById('btnSwap').onclick = ()=>{
      const p=state.pickup, d=state.dropoff; if(!(p&&d)) return;
      setPickup(d.lat, d.lng); setDropoff(p.lat, p.lng);
      tryRoute();
    };

    // Pricing controls
    document.getElementById('vehicle').onchange = (e)=>{ state.pricing.vehicle = e.target.value; recalcPrice(); };
    document.getElementById('weather').onchange = (e)=>{ state.pricing.weather = e.target.value; maybeSuggestVoucher(); recalcPrice(); };
    const traffic = document.getElementById('traffic');
    const trafficVal = document.getElementById('trafficVal');
    traffic.oninput = (e)=>{ state.pricing.traffic = +e.target.value; trafficVal.textContent = e.target.value; recalcPrice(); };

    // Payment
    document.querySelectorAll('#payGroup .tagpay').forEach(el=>{
      el.addEventListener('click', ()=>{
        document.querySelectorAll('#payGroup .tagpay').forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        state.pricing.payment = el.dataset.pay;
        maybeSuggestVoucher();
        recalcPrice();
      });
    });

    // Voucher
    document.getElementById('btnApplyVoucher').onclick = ()=>{
      if(state.pricing.voucherLocked){ alert('Voucher ƒë√£ √°p d·ª•ng cho chuy·∫øn n√†y.'); return; }
      const v = document.getElementById('voucher').value;
      if(!v){ alert('Ch·ªçn voucher tr∆∞·ªõc.'); return; }
      state.pricing.voucher = v;
      state.pricing.voucherLocked = true;
      document.getElementById('voucher').disabled = true;
      document.getElementById('btnApplyVoucher').disabled = true;
      recalcPrice();
    };

    // Booking
    const btnBook=document.getElementById('btnBook'); btnBook.disabled=false;
    btnBook.addEventListener('click', bookDriver);
    document.getElementById('btnCancel').onclick = cancelTrip;
    document.getElementById('btnFinish').onclick = ()=> openModal('ratingModal');

    // Rating
    const stars = document.querySelectorAll('#stars .star');
    stars.forEach(s=>{
      s.addEventListener('click', ()=>{
        const val = +s.dataset.val;
        stars.forEach(x=>x.classList.toggle('active', +x.dataset.val <= val));
      });
    });
    document.getElementById('btnCloseRating').onclick = ()=> closeModal('ratingModal');
    document.getElementById('btnSubmitRating').onclick = ()=>{
      const starsEls = document.querySelectorAll('#stars .star.active');
      const val = starsEls.length? starsEls.length : 5;
      const note = document.getElementById('ratingNote').value.trim();
      saveRating(val, note||'');
      closeModal('ratingModal');
      alert('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!');
      resetDriver();
      document.getElementById('btnBook').disabled=false;
    };

    // ESC to close modals
    window.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ closeModal('loginModal'); closeModal('ratingModal'); }
    });
  }

  // ====== Bootstrap ======
  (function(){
    try{ initMap(); } catch(e){ console.error(e); showMapLoadError(e); }
    wire();
    loadUser();
    recalcPrice();
    maybeSuggestVoucher();
    window.addEventListener('resize', ()=> state.map && state.map.invalidateSize());
  })();
  </script>
</body>
</html>
